---
title: 'Data visualization: tSNE'
output:
  pdf_document: default
  html_document: default
date: "05 November 2021"
---

## Practical Session tSNE
Please, complete all the code proposed and answer to questions. 

You will find these on the slides as (#) and (Q). You are not expected to include your answer to the check questions (C) or (K) knowledge thoughts. These are only to guide your progress. 

Change the code appropriately or add new lines if necessary.

Load data into variables: 

```{r message=FALSE, error=TRUE}
# First of all, set your working directory if necessary.
setwd("C:/Users/aless/Desktop/Bioinformatics/Erasmus BCN/Data Visualisation/p2_tSNE")

# Read data & metadata
P1_data = read.delim('P1.tsv.gz', row.names = 1)
P2_data = read.delim('P2.tsv.gz', row.names = 1)

treat = as.factor(readLines('treatment.txt'))

# Check the data and that we read in the data correctly:
print(head(P1_data)[,1:5])
print(head(P2_data)[,1:5])
print(treat)

print(dim(P1_data))
print(dim(P2_data))
print(table(treat))

```

Adapt the data accordingly and merge both tables of observations. Since we need columns of the tables to represent variables and rows to be samples, individuals, we need to transpose the data of the matrices. Then, we merged experiments into a single data.frame.

```{r, error=TRUE, message=FALSE}
# Modify the matrices.
X1 = t(P1_data)
X2 = t(P2_data)

# Merge replicates
X = rbind(X1, X2)
```

Check that we transformed the data correctly:
```{r results_transform, include=TRUE, error=TRUE}
print(dim(X1))
print(dim(X2))
print(dim(X))
```

Get metadata associated:
  
```{r get_data, error=TRUE}
meta_data <- data.frame(row.names = rownames(X), 
                        experiment= as.factor(rep(c("A","B"), each=96)),
                        treatment= treat)

head(meta_data)
```


Load package `Rtsne` and check the help. Run `install.packages("Rtsne")` if required.
```{r}
library(Rtsne)
help(Rtsne)
```

**Q1**. What are default values for perplexity, initial dimensions and iterations?

**A1**. The default values for perplexity, initial dimensions and iterations are 30, 50, and 1000 respectively.
  
A simple example of tSNE plot.

```{r, error=TRUE}
## Default parametnes for Rtsne
tsne1 <- Rtsne(X)

## Check results generated
names(tsne1)
head(tsne1$Y)

## Basic R plot
plot(tsne1$Y, col=treat)

tsne_data <- as.data.frame(tsne1$Y)
tsne_data$Experiment <- meta_data$experiment
tsne_data$Treatment <- meta_data$treatment

## ggplot
library(ggplot2)
ggplot(tsne_data, aes(x=V1, y=V2)) + 
  geom_point(aes(color=Treatment, shape=Experiment)) +
  scale_shape_manual(values = c(3,17)) +
  ggtitle("tSNE 2D plot") + xlab("tSNE1") + ylab("tSNE2") + 
  theme_classic() 
```

**Explore reproducibility of results**

Run a second tSNE with the same dataset and parameters:
  
```{r, error=TRUE}
tsne2 <- Rtsne(X)

names(tsne2)
head(tsne2$Y)

plot(tsne2$Y, col=treat)

tsne_data <- as.data.frame(tsne2$Y)
tsne_data$Experiment <- meta_data$experiment
tsne_data$Treatment <- meta_data$treatment

library(ggplot2)
ggplot(tsne_data, aes(x=V1, y=V2)) + 
  geom_point(aes(color=Treatment, shape=Experiment)) +
  scale_shape_manual(values = c(3,17)) +
  ggtitle("tSNE 2D plot") + xlab("tSNE1") + ylab("tSNE2") + 
  theme_classic() 
```

**Q2**Â· Are `tsne1` and `tsne2` the same? Why?

**A2**. No, `tsne1` and `tsne2` are not identical, because tSNE generation is stochastic, the starting point in chosen randomly each time.

**Explore `pca=TRUE`**:

**Q3**. In the `Rtsne` function, what does the `pca` option mean?

**A1**. The `pca` option in the `tSNE` function determines whether an initial PCA step should be performed.

Run tSNE again and test the effect of setting `pca` to `TRUE/FALSE`. 

Use `system.time()` to check time for each process.
```{r, error=TRUE}
t1 <- system.time(Rtsne(X, pca= TRUE)) # default
t2 <- system.time(Rtsne(X, pca= FALSE))
print(t1)
print(t2)
print(t1-t2)
```


**Explore `perplexity`**:

Create different tSNE with different perplexity values.
```{r, error=TRUE}
set.seed(123) ## allows us to reproduce results

for (p_value in c(1, 5, 10, 25, 50)) {
  tsne <- Rtsne(X)

  tsne_data <- as.data.frame(tsne$Y)
  tsne_data$Experiment <- meta_data$experiment
  tsne_data$Treatment <- meta_data$treatment
  
  library(ggplot2)
  p <- ggplot(tsne_data, aes(x=V1, y=V2)) + 
    geom_point(aes(color=Treatment, shape=Experiment)) +
    scale_shape_manual(values = c(3,17)) +
    ggtitle(paste("tSNE 2D plot: perplexity =", p_value)) + xlab("tSNE1") + ylab("tSNE2") + 
    theme_classic()
  print(p)
}

```

**Q4**. What is the effect of perplexity?

**A4**. The perplexity value controls how many nearest neighbours are taken into account when constructing the embedding in the low-dimensional space: with high perplexity values, the clusters will be more dense and defined.
  
Try to set a very big perplexity value.

```{r, error=TRUE}
set.seed(123) ## allows us to reproduce results
tsne_test <- Rtsne(X1, perplexity = 100)
```


**Q5**. What is the effect of the number of iterations?

**A5**. With more and more iterations, the distance between clusters becomes bigger, so with higher values of `max_iter`, we get tSNE plots with more distinct and defined clusters
  
Create different tSNE with different iterations values.

```{r, error=TRUE}
set.seed(123) ## allows us to reproduce results

for (max_iter in c(1, 10, 100, 500, 1000)) {
  tsne <- Rtsne(X)

  tsne_data <- as.data.frame(tsne$Y)
  tsne_data$Experiment <- meta_data$experiment
  tsne_data$Treatment <- meta_data$treatment
  
  library(ggplot2)
  p <- ggplot(tsne_data, aes(x=V1, y=V2)) + 
   geom_point(aes(color=Treatment, shape=Experiment)) +
   scale_shape_manual(values = c(3,17)) +
   ggtitle(paste("tSNE 2D plot: iterations =", max_iter)) + xlab("tSNE1") + ylab("tSNE2") + 
   theme_classic()
  print(p)
}

```

**Q6**. Identify and explain if there is any batch effect.

**A6**. Yes, there is evident batch effect as we get cdifferent clusters depending on the experiment from which the sample are coming from.

...

**Final plots**

Normalize and create PCA and tSNE:

```{r norm_data, error=FALSE}
X=X[, colSums(X)>0]
Y = X/rowSums(X)
tSNE_norm <- Rtsne(Y, pca=TRUE)

tsne_data3 <- as.data.frame(tSNE_norm$Y)
tsne_data3$Experiment <- meta_data$experiment
tsne_data3$Treatment <- meta_data$treatment

## ggplot
plot_p2 <- ggplot(tsne_data3, aes(x=V1, y=V2)) + 
  geom_point(aes(color=Treatment, shape=Experiment)) +
  scale_shape_manual(values = c(3,17)) +
  ggtitle("tSNE 2D plot: RNAseq normalization") + xlab("tSNE1") + ylab("tSNE2") + 
  theme_classic() 

print(plot_p2)

## create PCA
pca_norm <- stats::prcomp(Y, scale=TRUE)

library(ggfortify)
ggplot2::autoplot(pca_norm, data=meta_data, colour="treatment", shape="experiment") + theme_classic()

```

